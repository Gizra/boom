"use strict";angular.module("clientApp",["ngAnimate","ngCookies","ngSanitize","config","frapontillo.bootstrap-switch","LocalStorageModule","ui.bootstrap","ui.checkbox","ui.router","angular-loading-bar"]).config(["$stateProvider","$urlRouterProvider","$httpProvider","cfpLoadingBarProvider",function(a,b,c,d){var e=["$state","Auth","$timeout",function(a,b,c){b.isAuthenticated()||c(function(){a.go("403")})}];a.state("homepage",{url:"",controller:"HomepageCtrl",resolve:{account:["Account",function(a){return a.get()}]}}).state("login",{url:"/login",templateUrl:"views/login.html",controller:"LoginCtrl"}).state("github",{url:"/auth/github",templateUrl:"views/github-auth.html",controller:"GithubAuthCtrl"}).state("dashboard",{"abstract":!0,url:"",templateUrl:"views/dashboard/main.html",controller:"DashboardCtrl",onEnter:e,resolve:{account:["Account",function(a){return a.get()}],selectedCompany:["$stateParams",function(a){return a.companyId}]}}).state("dashboard.repos",{url:"/repos",templateUrl:"views/dashboard/repos/repos.html",controller:"ReposCtrl",resolve:{repos:["Repos",function(a){return a.get()}]}}).state("dashboard.builds",{url:"/builds",templateUrl:"views/dashboard/builds/builds.html",controller:"BuildsCtrl",resolve:{builds:["Builds",function(a){return a.get()}]}}).state("dashboard.screenshots",{url:"/screenshots/{buildId:int}",templateUrl:"views/dashboard/screenshots/screenshots.html",controller:"ScreenshotsCtrl",resolve:{screenshots:["Screenshots","$stateParams",function(a,b){return a.get(b.buildId)}],build:["Builds","$stateParams",function(a,b){return a.get(b.buildId)}]}}).state("dashboard.account",{url:"/my-account",templateUrl:"views/dashboard/account/account.html",controller:"AccountCtrl",onEnter:e,resolve:{account:["Account",function(a){return a.get()}]}}).state("403",{url:"/403",templateUrl:"views/403.html"}),b.otherwise("/"),c.interceptors.push(["$q","Auth","localStorageService",function(a,b,c){return{request:function(a){return a.url.match(/login-token/)||(a.headers={"access-token":c.get("access_token")}),a},response:function(a){return a.data.access_token&&c.set("access_token",a.data.access_token),a},responseError:function(c){return 401===c.status&&b.authFailed(),a.reject(c)}}}]),d.includeSpinner=!1,d.latencyThreshold=1e3}]).run(["$rootScope","$state","$stateParams","$log","Config",function(a,b,c,d,e){a.$state=b,a.$stateParams=c,e.debugUiRouter&&(a.$on("$stateChangeStart",function(a,b,c){d.log("$stateChangeStart to "+b.to+"- fired when the transition begins. toState,toParams : \n",b,c)}),a.$on("$stateChangeError",function(){d.log("$stateChangeError - fired when an error occurs during transition."),d.log(arguments)}),a.$on("$stateChangeSuccess",function(a,b){d.log("$stateChangeSuccess to "+b.name+"- fired once the state transition is complete.")}),a.$on("$viewContentLoaded",function(a){d.log("$viewContentLoaded - fired after dom rendered",a)}),a.$on("$stateNotFound",function(a,b,c,e){d.log("$stateNotFound "+b.to+"  - fired when a state cannot be found by its name."),d.log(b,c,e)}))}]),angular.module("clientApp").controller("ScreenshotsCtrl",["$scope","screenshots","build","Auth","filterFilter","Zip","Github","Screenshots","$log",function(a,b,c,d,e,f,g,h){a.showDiff=!1,a.screenshots=b,a.accessToken=d.getAccessToken(),a.repoName=b[0].repository.label,a.gitBranch=c[0].git_branch,a.gitCommit=c[0].git_commit.substring(0,6),a.prName="shoov-"+a.gitBranch,a.prUrl=c[0].pull_request,angular.forEach(a.screenshots,function(b,c){a.screenshots[c].selected=!1}),a.selection=[],a.selectedScreenshots=function(){return e(a.screenshots,{selected:!0})},a.$watch("screenshots|filter:{selected:true}",function(b){a.selection=b.map(function(a,b){return b})},!0),a["delete"]=function(b){h["delete"](b),angular.forEach(a.screenshots,function(c,d){c.id==b&&a.screenshots.splice(d,1)})},a.zip=function(){var b=a.selectedScreenshots();if(b){var c=[];b.forEach(function(a){var b={url:a.regression.self+"?access_token="+d.getAccessToken(),filename:a.baseline_name};c.push(b)}),f.createZip(c)}},a.pullRequest=function(){var b=a.selectedScreenshots();b&&(a.prProgress=!0,a.prUrl=null,g.createPullRequest(c[0].id,b,a.prName).then(function(b){a.prUrl=b.data[0].pull_request,a.prProgress=!1}))}}]),angular.module("clientApp").controller("LoginCtrl",["$scope","Auth","$state","Config",function(a,b,c,d){a.loginButtonEnabled=!0,a.loginFailed=!1,a.login=function(d){a.loginButtonEnabled=!1,b.login(d).then(function(){c.go("dashboard.builds")},function(){a.loginButtonEnabled=!0,a.loginFailed=!0})},a.githubClientId=d.githubClientId,a.githubPrivateAccess=!1}]),angular.module("clientApp").controller("GithubAuthCtrl",["$scope","$state","Auth","$window",function(a,b,c,d){var e=d.location.search.replace("?code=","");c.authByGithubCode(e).then(function(){b.go("dashboard.builds")})["catch"](function(a){console.log(a)})}]),angular.module("clientApp").service("Auth",["$injector","$rootScope","Utils","localStorageService","Config",function(a,b,c,d,e){this.login=function(b){return a.get("$http")({method:"GET",url:e.backend+"/api/login-token",headers:{Authorization:"Basic "+c.Base64.encode(b.username+":"+b.password)}})},this.logout=function(){d.remove("access_token"),b.$broadcast("clearCache"),a.get("$state").go("login")},this.isAuthenticated=function(){return!!d.get("access_token")},this.authFailed=function(){this.logout()},this.getAccessToken=function(){return d.get("access_token")},this.authByGithubCode=function(b){return a.get("$http")({method:"POST",data:{code:b},url:e.backend+"/auth/github"})}}]),angular.module("clientApp").service("Utils",function(){var a=this;this.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(b){var c,d,e,f,g,h,i,j="",k=0;for(b=a.Base64._utf8_encode(b);k<b.length;)c=b.charCodeAt(k++),d=b.charCodeAt(k++),e=b.charCodeAt(k++),f=c>>2,g=(3&c)<<4|d>>4,h=(15&d)<<2|e>>6,i=63&e,isNaN(d)?h=i=64:isNaN(e)&&(i=64),j=j+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h)+this._keyStr.charAt(i);return j},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):d>127&&2048>d?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b}}}),angular.module("clientApp").service("Screenshots",["$q","$http","$timeout","Config","$rootScope","$log",function(a,b,c,d,e){function f(c){var e=a.defer(),f=d.backend+"/api/screenshots",g={"filter[build]":c,sort:"-id"};return b({method:"GET",url:f,params:g}).success(function(a){i(c,a.data),e.resolve(a.data)}),e.promise}var g={},h="ShoovScreenshotsChange";this.get=function(b){return g&&g[b]?a.when(g[b].data):f(b)},this["delete"]=function(a){return b({method:"DELETE",url:d.backend+"/api/screenshots/"+a})};var i=function(a,b){g[a]={data:b,timestamp:new Date},c(function(){g.data&&g.data[a]&&(g.data[a]=null)},60),e.$broadcast(h)};e.$on("clearCache",function(){g={}})}]),angular.module("clientApp").controller("DashboardCtrl",["$scope","account","selectedCompany","Auth","$state","$log",function(a,b,c,d,e){a.logout=function(){d.logout(),e.go("login")}}]),angular.module("clientApp").directive("spinner",function(){return{template:'<div class="spinner"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div>',restrict:"E"}}),angular.module("clientApp").directive("loadingBarText",function(){return{restrict:"EA",template:'<div class="splash-screen" ng-show="isLoading"></div>',controller:["$scope",function(a){function b(b){a.isLoading=b}a.isLoading=!1,a.$on("cfpLoadingBar:started",function(){b(!0)}),a.$on("cfpLoadingBar:completed",function(){b(!1)})}],scope:{}}}),angular.module("clientApp").controller("AccountCtrl",["$scope","account","Auth","Config",function(a,b,c,d){a.account=b,a.accessToken=c.getAccessToken(),a.backend=d.backend}]),angular.module("clientApp").service("Account",["$q","$http","$timeout","Config","$rootScope","$log",function(a,b,c,d,e){function f(){var c=a.defer(),e=d.backend+"/api/me/";return b({method:"GET",url:e}).success(function(a){h(a.data[0]),c.resolve(a.data[0])}),c.promise}var g={};this.get=function(){return a.when(g.data||f())};var h=function(a){g={data:a,timestamp:new Date},c(function(){g={}},6e4),e.$broadcast("gb.account.changed")};e.$on("clearCache",function(){g={}})}]),angular.module("clientApp").controller("HomepageCtrl",["$scope","$state","account","$log",function(a,b,c){c||b.go("login"),b.go("dashboard.builds")}]),angular.module("clientApp").directive("beforeAfterImageSlider",function(){return{scope:{first:"@",second:"@",width:"@",height:"@"},template:'<div class="before-after-slider"><div class="first-wrapper"><img ng-src="{{ first }}" width="{{ width }}" height="{{ height }}" alt="first" /></div><div class="second-wrapper"><img ng-src="{{ second }}" width="{{ width }}" height="{{ height }}"  alt="second" /></div></div>',link:function(a,b){var c=b.find(".second-wrapper"),d=b.find(".second-wrapper img").width(),e=Math.round(d/2);c.width(e),b.find(".before-after-slider").mousemove(function(a){var b=a.offsetX||a.clientX-c.offset().left;c.width(b)})}}}),angular.module("clientApp").service("Zip",["$q",function(a){function b(b,c,d){var e=a.defer();return JSZipUtils.getBinaryContent(b,function(a,b){a?e.reject(a):(d.file(c,b,{binary:!0}),e.resolve(b))}),e.promise}this.createZip=function(c){var d=new JSZip,e=[];c.forEach(function(a){e.push(b(a.url,a.filename,d))}),a.all(e).then(function(){var a=d.generate({type:"blob"});saveAs(a,"shoov.zip")})}}]),angular.module("clientApp").service("Builds",["$q","$http","$timeout","Config","Repos","$rootScope","$log",function(a,b,c,d,e,f){function g(c){var e=a.defer(),f=d.backend+"/api/builds";c&&(f+="/"+c);var g={sort:"-id"};return b({method:"GET",url:f,params:g}).success(function(a){j(c,a.data),e.resolve(a.data)}),e.promise}var h={},i="ShoovBuildChange";this.get=function(b){return h&&h[b]?a.when(h[b].data):g(b)},this.create=function(a){return b.post(d.backend+"/api/ci-builds",a)},this.enable=function(a){var c={},f=this;return parseInt(a.shoov_id)?a.build&&!a.build.id?(c={label:a.label,branch:a.branch,repository:a.shoov_id},this.create(c)):(c={enabled:!0,branch:a.branch},b.patch(d.backend+"/api/ci-builds/"+a.build.id,c)):e.create(a.label).then(function(b){var d=b.data.data[0];return c={label:d.label,branch:a.branch,repository:d.id},f.create(c)})},this.disable=function(a){return a.build&&a.build.enabled?b.patch(d.backend+"/api/ci-builds/"+a.build.id,{enabled:!1}):void 0};var j=function(a,b){h[a]={data:b,timestamp:new Date},c(function(){h[a]=null},5e3),f.$broadcast(i)};f.$on("clearCache",function(){h={}})}]),angular.module("clientApp").controller("BuildsCtrl",["$scope","builds","Auth","Config",function(a,b,c,d){a.builds=b,a.accessToken=c.getAccessToken(),a.backend=d.backend}]),angular.module("clientApp").service("Repos",["$q","$http","$timeout","Config","$rootScope","$log",function(a,b,c,d,e){function f(c){var e=a.defer(),f=d.backend+"/api/github_repos";c&&(f+="/"+c);var g={sort:"-id"};return b({method:"GET",url:f,params:g}).success(function(a){i(c,a.data),e.resolve(a.data)}),e.promise}var g={},h="ShoovReposChange";this.create=function(a){return b.post(d.backend+"/api/repositories",{label:a})},this.get=function(b){return g&&g[b]?a.when(g[b].data):f(b)};var i=function(a,b){g[a]={data:b,timestamp:new Date},c(function(){g.data&&g.data[a]&&(g.data[a]=null)},5),e.$broadcast(h)};e.$on("clearCache",function(){g={}})}]),angular.module("clientApp").controller("ReposCtrl",["$scope","repos","Builds","Repos","$log",function(a,b,c){a.repos=b;var d=function(b){var c=0;return angular.forEach(a.repos,function(a,d){b.id==a.id&&(c=d)}),c};a.toggleRepo=function(b){var e=d(b);a.repos[e]._inProgress=!0,b.build&&b.build.enabled?c.disable(b).then(function(){a.repos[e].build.enabled=!1,a.repos[e]._inProgress=!1}):c.enable(b).then(function(b){var c=b.data.data[0];a.repos[e].build={enabled:!0,id:c.id},a.repos[e].shoov_id=c.repository,a.repos[e]._inProgress=!1})}}]),angular.module("clientApp").service("Github",["$http","Config",function(a,b){this.createPullRequest=function(c,d,e){var f=[];return d.forEach(function(a){f.push(a.id)}),a({method:"PATCH",url:b.backend+"/api/builds/"+c,data:{pull_request_screenshot_ids:f.join(","),pull_request_branch_name:e,pull_request_status:"requested"}})}}]);