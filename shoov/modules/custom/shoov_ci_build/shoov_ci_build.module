<?php
/**
 * @file
 * Code for the Shoov CI Build feature.
 */

include_once 'shoov_ci_build.features.inc';

/**
 * Return the CI builds that are waiting for processing.
 *
 * @param int $timestamp
 *   The timestamp of "now". If empty, the existing current time will be used.
 * @param int $range
 *   The number of maximum items to return. Defaults to 50.
 *
 * @return array
 *   Array of Message objects, or NULL if none found.
 */
function shoov_ci_build_get_ci_builds($timestamp = NULL, $range = 50) {
  $timestamp = $timestamp ?: time();

  $query = new EntityFieldQuery();
  $result = $query
    ->entityCondition('entity_type', 'message')
    ->entityCondition('bundle', 'ci_build')
    ->fieldCondition('field_ci_build_timestamp', 'value', $timestamp, '<=')
    ->fieldCondition('field_ci_build_status', 'value', 'queue')
    ->range(0, $range)
    ->propertyOrderBy('mid')
    ->execute();

  if (empty($result['message'])) {
    return;
  }

  return message_load_multiple(array_keys($result['message']));
}

/**
 * Implements hook_node_insert().
 *
 * Create a CI build item when a new CI build node is created.
 */
function shoov_ci_build_node_insert($node) {
  shoov_ci_build_create_build_item($node);
}

/**
 * Create a CI build item.
 *
 * @param $node
 *   The CI-build node object.
 * @param int $timestamp
 *   The timestamp of "now". If empty, the existing current time will be used.
 *
 * @return Message
 *   The message object.
 */
function shoov_ci_build_create_build_item($node, $timestamp = NULL) {
  if ($node->type != 'ci_build') {
    return;
  }

  $timestamp = $timestamp ?: time();

  $message = message_create('ci_build', array('uid' => $node->uid));
  $wrapper = entity_metadata_wrapper('message', $message);
  $wrapper->field_ci_build->set($node);
  $wrapper->field_ci_build_status->set('queue');
  // Set to be invoked immediatly.
  $wrapper->field_ci_build_timestamp->set($timestamp);

  $wrapper->save();
  return $message;
}

/**
 * Implements hook_message_update().
 *
 * @param \Message $message
 *   The message object.
 */
function shoov_ci_build_message_update(Message $message) {
  $wrapper = entity_metadata_wrapper('message', $message);
  $status = $wrapper->field_ci_build_status->value();
  dpm($status);
  if (!in_array($status, array('error', 'done'))) {
    // Item still in progress.
    return;
  }

  if (!$wrapper->field_ci_build->field_ci_build_enabled->value()) {
    // CI build is disabled.
    return;
  }

  $node = $wrapper->field_ci_build->value();

  // @todo: Make configurable.
  $timestamp = strtotime('+3 minutes');

  shoov_ci_build_create_build_item($node, $timestamp);
  shoov_ci_build_set_build_status($message);
}

/**
 * Set the status of the CI build on failure, and clear when it's fixed.
 *
 * @param \Message $message
 *   The message object.
 */
function shoov_ci_build_set_build_status(Message $message) {
  $wrapper = entity_metadata_wrapper('message', $message);

  $status = $wrapper->field_ci_build_status->value();

  if (!in_array($status, array('done', 'error'))) {
    return;
  }

  $build_wrapper = $wrapper->field_ci_build;

  $failed_build = $build_wrapper->field_failing_build->value();

  $save = FALSE;
  if (!$failed_build && $status == 'error') {
    // Set an error.
    $build_wrapper->field_failing_build->set($message);
    $save = TRUE;
  }
  elseif ($failed_build && $status == 'done') {
    // Clear up the error.
    $build_wrapper->field_failing_build->set(NULL);
    $save = TRUE;
  }

  if (!$save) {
    return;
  }

  $wrapper->field_ci_build->save();

  // Send a message to all following members.
  // The message itself will take care of sending the right message by status.
  $build_node = $build_wrapper->value();
  message_subscribe_send_message('node', $build_node, $message, array(), array('save message' => FALSE));
}