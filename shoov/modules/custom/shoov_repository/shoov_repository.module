<?php
/**
 * @file
 * Code for the Shoov Repository feature.
 */

include_once 'shoov_repository.features.inc';

/**
 * Implements hook_node_presave().
 *
 * Get the GitHub repo ID for a local repository.
 */
function shoov_repository_node_presave($node) {
  if ($node->type != 'repository') {
    // Not a repository node.
    return;
  }

  $wrapper = entity_metadata_wrapper('node', $node);
  if ($wrapper->field_github_id->value()) {
    shoov_repository_check_github_id_unique($wrapper->field_github_id->value(), isset($node->nid) ? $node->nid : FALSE);
    // GitHub Id already populated.
    return;
  }

  list($owner, $repo) = explode('/', $node->title);

  $user_wrapper = entity_metadata_wrapper('user', $node->uid);
  $access_token = $user_wrapper->field_github_access_token->value();

  $options = array(
    'headers' => array(
      'Authorization' => 'token ' . $access_token,
    ),
  );

  $data = shoov_github_http_request("repos/$owner/$repo", $options);

  // @todo: Throw exception on error?
  if (!empty($data['id'])) {
    shoov_repository_check_github_id_unique($wrapper->field_github_id->value(), $node->nid);
    $wrapper->field_github_id->set($data['id']);
  }
}

/**
 * Check repository GitHub id is unique.
 *
 * @param int $github_id
 *  Repository GitHub id.
 * @param int|NULL $nid
 *  Optional; Repository node ID for an existing node to exclude.
 *
 * @throws Exception
 *  Throw exception is this GitHub id is already used.
 */
function shoov_repository_check_github_id_unique($github_id, $nid = NULL) {
  $query = new EntityFieldQuery();
  $query
    ->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'repository');
  if ($nid) {
    $query->propertyCondition('nid', $nid, '<>');
  }
  $result = $query
    ->fieldCondition('field_github_id', 'value', $github_id)
    ->execute();

  print_r('nid=' . $nid . ' github=' . $github_id);
  print_r($result);

  if (empty($result['node'])) {
    return;
  }

  throw new Exception(format_string('Error saving node: Repository with GitHub ID @githubid already exists.', array('@githubid' => $github_id)));
}

/**
 * Implements hook_node_insert().
 *
 * Trigger event when new repository is created. Send new repository's data to
 * the client.
 */
function shoov_repository_node_insert($node) {
  if ($node->type != 'repository') {
    return;
  }

  $account = user_load($node->uid);
  $handler = restful_get_restful_handler('repositories');
  $handler->setAccount($account);
  $result = $handler->get($node->nid);

  $data = array($result[0]);

  shoov_pusher_trigger_user_event($node->uid, 'new_repo', $data);
}
